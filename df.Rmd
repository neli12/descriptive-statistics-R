---
title: "Tutorial básico - R scripts"
author: "Nélida Elizabet Quiñonez Silvero"
date: "05/08/2020"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Com este tutorial pretende-se oferecer um exemplo de como acessar e utilizar scripts de R disponibilizados no Github do grupo GEOCIS. Este exemplo serve como base para todos os demais scripts que se encontram na plataforma. Neste exemplo, iremos calcular estatísticas descritivas, realizar gráficos simples (histogramas, boxplots e ggridges) e salvar com resolução de 300 dpi. O conjunto de dados que iremos utilizar como exemplo contém pouco mais de 100 observações, com vários atributos fisico-químicos do solo e análises espectrais.

### Acessando os dados salvos no GitHub

Você deve acessar a conta do **GEOCIS** no [GitHub](www.github.com) e descargar o arquivo **dados.csv** e o  
**script_descriptive_statistics.R**. Com eles iremos fazer este primer tutorial. Os dados do acesso são os seguintes:  
 * nome de usuário ou email: GEOCIS (geocis@usp.br)  
 * senha: geocis_2020  


### Instalando pacotes

O primeiro paso consiste em carregar os pacotes necessários para conduzir a análise

```{r results='hide', message=FALSE, warning=FALSE}
library(rgdal)  
library(e1071)
library(dgof)
library(ggpubr)
library(EnvStats)
library(rcompanion)
library(tmap)
library(sf)
library(leaflet) 
library(reshape)
library(ggridges)
library(PerformanceAnalytics)
```

### Definindo o diretório de trabalho

No código abaixo, o nome entre aspas corresponde ao diretório onde se encontram salvos os arquivos que foram baixados do Github. Troque o nome dentro do parentesis pelo seu diretório de trabalho.

```{r}
setwd("D:/GitHub_scripts/R_scripts/descriptive_statisctics")
```


### Carregando os dados

No R trabalhamos com objetos. O objeto dat1 recebe os dados que se encontram no arquivo dados.csv
```{r}
dat1 <- read.csv("dados.csv", h=TRUE, sep=";") #o argumento "sep" pode ser diferente ";" ou "," 
#dependendo das configurações do seu computador
```

O conjunto de dados que acabamos de carregar no R não contem valores nulos, mas em alguns casos você pode ter. A função **complete.cases()** serve para excluir as linas ou colunas que contém valores nulos ou NA. Preste atenção com esta função, porque ela exclue toda a linha ou coluna com NAs.

```{r}
dat2 <- dat1[complete.cases(dat1),]  #com esta função sao excluidos os valores nulos (NA)
```


O seguinte paso consiste em excluir os dados espectrais, que não utilizaremos nesta primeira etapa. O jeito de excluir ou selecionar algumas colunas de um conjunto de dados é usando []. Cada coluna corresponde a um numero. Por exemplo, no código abaixo estamos selecionando as colunas 1 a 20. As demais são excluidas do novo objeto dat3. Nele temos informação do ID, coordenadas e propriedades do solo

```{r}
dat3 <- dat2[,1:20]
summary(dat3)
```

Podemos também ver onde os pontos foram coletados. Com o pacote leaflet é possível obter gráficos iterativos. Os pontos foram coletados perto de Piracicaba.

```{r eval = FALSE}
glimpse(dat3)
leaflet(data = dat3) %>%
  addTiles() %>%
  addMarkers(lng = ~X, lat=~Y) %>%
  frameWidget()
```
![Local de coleta das amostras de solo](/GitHub_scripts/R_scripts/descriptive_statisctics/image_cap2.png)

### Calculando estatísticas básicas

Há várias formas de fazer uma análise exploratória dos dados, o que deve ser o primeiro paso antes de qualquer análise. Podemos utilizar a função **summary()**  ou podemos ver a distribuição dos dados utilizando histogramas. Abaixo temos o histograma para o conteúdo de argila, que é a forma mais simples de ver a distribuição dos dados. Com o $ selecionamos a coluna onde se encontra a variável de interesse que queremos graficar. Também podemos usar o boxplot. O histograma e o boxplot representam a distribuição dos seus dados. A principal diferença entre eles é que o histograma mostra a frequência dos valores e o boxplot mostra outros parâmetros, como os quantis 25, 50 (mediana) e 75, e os possíveis valores discrepantes (outliers) presentes nos dados.

#### Histograma e boxplot:
Fazer o gráfico de distribuição dos dados é bem simples, utilizando a função **hist()** ou **boxplot()**. Ambas as funções recebem argumentos para melhorar a visualização, como por exemplo o titulo do grafico e os labels do eixo x e y. Há aqui um caso especial com a unidade de medida. Como o conteudo de argila é uma expressão, usamos a função **expression** para fazer com que o -1 seja expoente e a função paste para juntar a expressão com o nome. Caso o label não seja uma expressão, basta colocar o nome do atributo entre aspas. Se nenhum label é necessário, é possivel deixar somente as aspas, como exemplificado no código abaixo para o argumento main = "".

```{r}
par(mfrow=c(1,2))
hist(dat3$Clay.gkg, main = "", 
     xlab = expression(paste("Clay content (g ", kg ^-1, ")")))
boxplot(dat3$Clay.gkg) 
```


#### Verificar normalidade: 
Podemos verificar a normalidade com o teste de  [Shapiro Wilk](https://en.wikipedia.org/wiki/Shapiro%E2%80%93Wilk_test) e assimetria e curtose usando as seguintes funções:

```{r}
shapiro.test(dat3$Clay.gkg)
kurtosis(dat3$Clay.gkg)
skewness(dat3$Clay.gkg)
```
O teste de Shapiro Wilk testa a hipótese de que o conjunto de dados provém de uma distribuição normal. Se o p-value é maior do que 0.05, nossos dados apresnetam distribuição normal. No caso aqui apresentado, pelo histograma e boxplot obtidos acima e pelo valor de teste de Shapiro, podemos concluir que temos uma distribuição aproximadamente normal. Dependendo do teste que se pretende fazer, talvez seja necessária uma transformação para aproximar os dados à uma distribuição normal. No caso aqui não iremos fazer essa transformação. A curtose e o skewness também servem para dar uma ideia da distribuição dos dados, principalmente se ela é assimetrica e se esta mais achatada ou não.

Para testar a normalidade podemos utilizar o qqplot. O gráfico Q-Q, ou gráfico quantil-quantil, é uma ferramenta gráfica que ajuda a avaliar se um conjunto de dados segue uma distribuição teórica, por exemplo a normal. É apenas uma verificação visual, por isso é um pouco subjetiva. Mas nos permite ver rapidamente se nossa suposição é plausível e, se não, como a suposição é violada e quais pontos de dados contribuem para a violação.


```{r}
ggqqplot(dat3$Clay.gkg)
```

 Um gráfico Q-Q é um gráfico de dispersão criado pela plotagem de dois conjuntos de quantis um contra o outro. Se os dois conjuntos de quantis vierem da mesma distribuição, veremos os pontos formando uma linha que é aproximadamente reta. Acima podemos ver um exemplo de um gráfico Q-Q normal quando os dois conjuntos de quantis vêm de distribuições aproximadamente normais.
 
 
 ### Gráficos de distribuição dos dados
 
 Existem várias formas de apresentar a distribuição de um conjunto de dados. Podemos fazé-lo via histogramas e boxplots, como mencionado anteriormente e também podemos utilizar melhores visualizações como o ggridges. Os seguintes códigos podem ser utilizados para obter e salvar gráficos em alta resolução. Para isso, utilizaremos somente os valores de areia, silte e argila, que selecionaremos do nosso conjunto dat3 e daremos o nome de texture:

```{r message=FALSE}
texture <- dat3[,6:8] #selecionar as colunas 6 a 8
colnames(texture) <- c("Clay", "Silt", "Sand") #renomear as colunas
texture.melt <- melt(texture) #reshape dos dados
head(texture.melt) #cabeçalho dos seis primeiros dados
tail(texture.melt) #seis ultimos dados
```


No R podemos salvar gráficos em alta resolução. Como geralmente trabalhamos com gráficos para publicação científica, as revistas exigem que a resolução seja de pelo menos 300 dpi. Para isso, podemos usar a função **tiff()**, cujos argumentos são: o nome do arquivo com a extensão .tif, o comprimento (height) e a largura (width) do gráfico, e a resolução (res). No códigto abaixo a linha começa com o # porque foi colocado como comentário. Somente deve ser abilitada quando a ideia é salvar o gráfico. Se o objetivo é visualizar no R, esta linha de código não precissa ser executada. No final do código também está a função **dev.off()** que ajuda a salvar o gráfico. De novo, somente deve ser executada quando o interesse é salvar o gráfico. Os argumentos width e height podem ser modificados dependendo do tamanho desejado do gráfico.
```{r}
#Boxplots
#tiff("boxplotplot_texture.tif", width = 2200, height = 1500, res = 300)
ggplot(texture.melt, aes(x = variable, y = value)) + 
  geom_boxplot(aes(fill = variable, alpha = 0.8)) + theme_bw() + 
  xlab("") + ylab(expression(paste("Content (g ", kg^-1, ")"))) +
  theme(legend.position = "none")
#dev.off()
```



```{r message=FALSE, warning = FALSE}
##ggridges##
#tiff("boxplotplot_texture.tif", width = 2200, height = 1500, res = 300)
#to adjust the graph, you can change the width and height arguments#
ggplot(texture.melt, aes(x = value, y = variable, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, gradient_lwd = 1.) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expand_scale(mult = c(0.01, 0.25))) +
  scale_fill_viridis_c(name = expression(paste("Content (g ",kg^-1, ")", sep="")), 
                       option = "C") + labs(title = 'Particle size distributions') +
  theme_ridges(font_size = 13, grid = TRUE) + theme(axis.title.y = element_blank())
#dev.off()
```


```{r}
##Histograms
#tiff("histogram_texture.tif", width = 2200, height = 1500, res = 300)
par(mfrow=c(1,3), mar=c(5,4,2,2))  #divide the window in 3 columns
plotNormalHistogram(texture$Clay, ylab="Frequency",
                    xlab=expression(paste("Clay content (g ",kg^-1, ")", sep="")), 
                    xlim = c(0,1000))
plotNormalHistogram(texture$Silt, ylab = "", 
                    xlab=expression(paste("Silt content (g ",kg^-1, ")", sep="")), 
                    xlim = c(0,1000))
plotNormalHistogram(texture$Sand, ylab = "", 
                    xlab=expression(paste("Sand content (g ",kg^-1, ")", sep="")), 
                    xlim = c(0,1000))
#dev.off()
```

Assim, finalizamos este primer tutorial básico de uso de script no R para calculo de estatísticas básicas.